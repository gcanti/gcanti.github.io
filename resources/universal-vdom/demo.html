---
layout: clean
title: Universal VDOM demo
---

<!--[if lt IE 9]>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.18.0/es6-shim.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.18.0/es6-sham.min.js"></script>
<![endif]-->
<link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/0.11.2/react.min.js"></script>
<div id="app"></div>
<script>
// React v0.11.2

/*
  
  UNIVERSAL VDOM

  type Node = {
    tag: string,
    attrs: Nil | Attrs,
    children: Child | Array<Child>
  }

  type Nil = null | undefined

  type Attrs = {
    className: Nil | string | Array<string> | ClassName,
    style: Nil | Style,
    onClick: function,
    etc..
  }

  type ClassName = Dictionary<boolean> // like React cx()

  type Style = {
    'text-align': string,
    'z-index': number,
    etc..
  }

  type Child = Nil | string | Node

*/

//
// helpers
//

// transforms an array or an hash of classes to a string
function cx(classNames) {
  if (Array.isArray(classNames)) {
    return classNames.join(' ');
  } else if (typeof classNames === 'object') {
    return Object.keys(classNames).filter(function(className) {
      return classNames[className];
    }).join(' ');
  }
  return classNames;
}

// useful to preserve the original hash
function clone(x) {
  var ret = {};
  for (var k in x) {
    if (x.hasOwnProperty(k)) ret[k] = x[k];
  }
  return ret;
}

// toReactElement: VDOM -> ReactElement
// transforms a universal vdom to a React renderable
function toReactElement(vdom) {
  
  var tag = vdom.tag;
  var attrs = vdom.attrs;
  if (attrs) {
    attrs = clone(attrs);
    attrs.className = cx(attrs.className);
  }
  var children = vdom.children;

  if (typeof tag === 'string') {
    tag = React.DOM[tag];
  }
  
  if (Array.isArray(children)) {
    children = children.map(toReactElement);
  } else if (typeof children === 'object') {
    children = toReactElement(children);
  }

  // use `apply` to avoid React warnings
  return React.createElement.apply(React, [tag, attrs].concat(children));
}

// toReactClass: (Func, Func) -> ReactClass
// tranforms a pair (controller, view) to a React class
function toReactClass(controller, view) {
  return React.createClass({
    render: function () {
      var state = this.props;
      var v = view(state, controller(state, this.setProps.bind(this)));
      return toReactElement(v);
    }
  });
}

//
// example 
// Note how both controller and view are decoupled from React
// I'll try to compile them to Mithril, mercury, Ractive, etc.....
// (another issue is composition)
// 

function controller(state, setState) {
  return {
    doIncrement: function () {
      // `state` and `setState` aren't React things
      setState({count: state.count + 1});
    }
  };
}

function view(state, controller) {
  return {
    tag: 'div',
    children: [
      {
        tag: 'h1',
        children: state.count
      },
      {
        tag: 'button',
        attrs: {
          className: {'btn': true, 'btn-primary': true},
          onClick: controller.doIncrement
        },
        children: 'Click me'
      }
    ]
  };
}

var CounterComponent = toReactClass(controller, view);
var state = {count: 0};

React.renderComponent(CounterComponent(state), document.getElementById('app'));
</script>